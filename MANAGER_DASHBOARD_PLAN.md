# Manager Dashboard Completion & Enhancement Plan

Date: 2025-10-14  
Scope: Deliver a fully functional Manager Dashboard with real-time, secure, performant access to team performance, employee directory (read‑only profiles), attendance tracking (searchable), leave request management (approve/reject), and persistent team announcements. Add finishing polish across UX, accessibility, reliability, observability, and documentation.

---

## 1. Current State vs Required Features

| Feature                              | Current Status                                                    | Gaps / Needed Enhancements                                                                                                                                   |
| ------------------------------------ | ----------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| Auth & Role Gate                     | Middleware + role check (redirect)                                | Centralize role guard helper; add audit logging (manager actions).                                                                                           |
| Average Weekly Performance           | `TeamPerformance` component calculates last 7 days avg            | Add loading/error fallback message; cache layer; handle no evaluations gracefully (already partially). Possibly visualize trend (sparklines).                |
| Employee List (ID + Name)            | `TeamEmployees` shows ID, name, position + View Profile dialog    | Add search & optional pagination if team large; restrict columns fetched; add skeleton already present; audit open profile action if sensitive.              |
| View Employee Profile (Read-only)    | Dialog includes personal & emergency info                         | Add data classification & conceal sensitive fields unless policy allows (e.g. emergency contact maybe manager-only is fine); add print/export (optional).    |
| Attendance Tracking (Filter by Name) | `ManagerAttendanceTracking` with search & last 30 days            | Add column for status legend tooltip; add date range filter & CSV export; performance: move mapping logic server side / use single RPC.                      |
| Leave Requests (Approve/Reject)      | `ManagerLeaveRequests` with actions & toasts                      | Add confirmation dialog (reject reason input); optimistic updates; filter by status; pagination; audit trail (store approved_by & rejection_reason already). |
| Team Announcements (Create)          | UI only; DOES NOT persist                                         | Add `team_announcements` table + RLS + list existing recent announcements; allow delete (manager only) & expiry; show most recent N to employees.            |
| Security / RLS                       | Core tables have RLS + manager policies for SELECT/UPDATE (leave) | Need policies for announcements; refine employees policy to avoid duplicate exposure if overlapping; consider separate admin bypass policies.                |
| Error Handling                       | Console errors + toasts                                           | Add error boundary component; central Supabase error normalizer; structured logging.                                                                         |
| Testing                              | None specified                                                    | Add unit tests (utils), integration (Supabase queries via service role in CI), E2E (Playwright).                                                             |
| Docs                                 | Multiple markdowns exist                                          | Add this plan + update USAGE_GUIDE & ROLE_BASED_AUTH for manager flows.                                                                                      |

---

## 2. Data Model Additions & Adjustments

### 2.1 New Table: `team_announcements`

```sql
create table if not exists public.team_announcements (
  id bigint generated by default as identity primary key,
  department_id bigint not null references public.departments(id) on delete cascade,
  created_by bigint not null references public.employees(id) on delete set null,
  message text not null,
  expires_at timestamptz,
  pinned boolean default false,
  created_at timestamptz not null default now()
);

alter table public.team_announcements enable row level security;
```

### 2.2 RLS Policies

- Read: Authenticated users whose employee.department_id = announcement.department_id
- Insert: Only employees who are managers of that department (match departments.manager_id OR user role claim == "manager" and same department)
- Update/Delete: Only creator OR department manager (for pin/unpin or removal)

Example policies (pseudo):

```sql
create policy "announcements viewable to department" on public.team_announcements
for select to authenticated using (
  department_id in (
    select e.department_id from public.employees e where e.user_id = auth.uid()
  )
);

create policy "announcements insert by manager" on public.team_announcements
for insert to authenticated with check (
  (select e.id from public.employees e where e.user_id = auth.uid() limit 1) in (
    select d.manager_id from public.departments d where d.id = team_announcements.department_id
  )
);
```

(Adjust to actual final logic + maybe a helper secure function—detailed implementation step below.)

### 2.3 Optional Enhancements

- Materialized weekly performance view for large data sets later: `department_weekly_performance (department_id, week_start, avg_score)` with CRON refresh.
- Attendance summary view for aggregated hours & statuses.

---

## 3. Supabase Client & Server Layer Enhancements

| Concern                    | Action                                                                                                                                     |
| -------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------ |
| Repeated client-side joins | Add server-side edge function or RPC to fetch aggregated attendance + employee names in one call.                                          |
| Error standardization      | Utility `normalizeSupabaseError(error): { code, message }`.                                                                                |
| Caching (optional)         | Use Next.js route segment caching for read-mostly endpoints (performance panel) with revalidation (60s).                                   |
| Audit logging              | Create lightweight server action to log manager actions (approve/reject, announcement create) into `audit_events` table (optional future). |

`audit_events` (optional future): id, actor_employee_id, action_type, entity, entity_id, metadata jsonb, created_at.

---

## 4. UI / Component Enhancements

### 4.1 Announcements Component

- Fetch existing announcements (limit 10, order by pinned DESC, created_at DESC)
- Show relative time (e.g., "2h ago")
- Add pinned badge & filter out expired (expires_at < now())
- Provide form fields: message (required), optional expiry datetime, pin toggle
- Provide delete & pin/unpin buttons (only for manager)

### 4.2 Leave Requests

- Add status filter (All / Pending / Approved / Rejected)
- Add confirmation dialog for rejection with reason textarea
- Optimistic UI update (update local state before refetch) with rollback on error

### 4.3 Attendance Tracking

- Add date range picker (default last 30 days)
- Show total present days vs absences summary bar above table
- Provide export CSV button (client-side generated)

### 4.4 Team Employees

- Add search by name / ID (client filter first; server search later if large)
- Add optional column toggle (position, date of joining)
- Provide copy-to-clipboard for employee email

### 4.5 Performance Card

- Add 7-day trend sparkline (reuse `chart.tsx` primitives)
- Show count of evaluations included in average

### 4.6 Global Enhancements

- Create `LoadingState` & `ErrorState` small components for reuse.
- Add accessible focus management when dialogs open/close.

---

## 5. Routing & Access Control

| Route                  | Guard                                                               |
| ---------------------- | ------------------------------------------------------------------- |
| `/manager/dashboard`   | Role: manager OR admin; redirect else                               |
| Announcement mutations | Validate manager ownership of department client & server side       |
| Leave approval         | Double-check managerId belongs to matching department before update |

Add helper: `assertManagerOfDepartment(supabase, user_id, department_id)` returning boolean; used in server actions (if introduced) to prevent forged client updates.

---

## 6. Implementation Steps (Detailed)

1. Migration: add `team_announcements` table & RLS policies.
2. Update `supabase/migrations/` with new timestamped SQL file.
3. Extend `lib/types.ts` with `TeamAnnouncement` interface.
4. Enhance `TeamAnnouncements` component:
   - Replace mock with real Supabase CRUD (list, create, delete, pin toggle).
   - Add local optimistic updates.
5. Enhance `ManagerLeaveRequests`:
   - Add filters, rejection reason dialog, optimistic status update.
6. Improve `ManagerAttendanceTracking`:
   - Add date range filter, summary stats, CSV export.
7. Improve `TeamEmployees`:
   - Add search, column toggle, small UI utilities.
8. Add `TeamPerformance` sparkline (query more than one week: last 6 weeks, aggregate weekly client side or via RPC).
9. Shared utilities: `useAsync` hook for loading/error; `formatters.ts` for date/time.
10. Introduce audit logging optional (stretch if time allows).
11. Add tests (see section 10).
12. Update docs (README feature list, ROLE_BASED_AUTH, USAGE_GUIDE).
13. Final QA + accessibility review.
14. Deployment & migration run instructions.

---

## 7. Security & RLS Considerations

- Sensitive profile fields are already restricted by policy (currently employees table policy lets managers view by department; confirm least privilege: ensure no cross-department leakage through OR conditions).
- Add explicit policy limiting employees SELECT to either self OR same department as manager; current policy "managers can view team employees" combined with owner policy is fine but review for duplicates.
- Ensure announcement insertion restricted: only department manager; may need to set `departments.manager_id` field (add update migration linking existing manager accounts if not set).
- Validate on mutation that manager's `employees.department_id` equals target department (defense-in-depth beyond RLS).
- Rate-limit announcements (client-side min interval; future: edge function + throttle table).

---

## 8. Performance Optimizations

| Area                      | Optimization                                                                             |
| ------------------------- | ---------------------------------------------------------------------------------------- |
| Attendance query          | Single SELECT with required columns only; potential server RPC returning joined records. |
| Repeated employee lookups | Cache employee map in context provider for dashboard session.                            |
| Performance evaluations   | Request only `performance_score` & `evaluation_period_end`.                              |
| Announcements list        | Limit to recent N & apply incremental fetch (Load more).                                 |
| Rendering                 | Use React.memo for table rows if dataset large; virtualization (future if >500 rows).    |

---

## 9. Observability & Error Handling

- Central `logError(context, error)` util (structured: { component, action, message, stack }).
- Toast user-friendly messages; hide raw Supabase errors.
- Optional Sentry integration (environment variable toggled) for production.
- Error boundary around manager dashboard child components.

---

## 10. Testing Strategy

| Test Type              | Scope                                                                                                                                     |
| ---------------------- | ----------------------------------------------------------------------------------------------------------------------------------------- |
| Unit                   | Utilities (formatDate, CSV export), hooks (useAsync).                                                                                     |
| Integration (Supabase) | Announcement CRUD with service role key; leave approval updates status/approved_by; RLS negative tests (unauthorized should fail).        |
| E2E (Playwright)       | Manager login -> dashboard loads; approve leave request; create announcement -> appears; filter attendance; open employee profile dialog. |
| Accessibility          | axe automated scan for dashboard page & dialogs.                                                                                          |

CI Pipeline Additions:

- Run migrations against ephemeral DB
- Seed minimal test data (avoid dummy wide dataset for speed)
- Execute unit + integration + e2e headless

---

## 11. Accessibility & UX Polish

- Provide aria-labels for action buttons (Approve/Reject with request ID for screen readers)
- Ensure dialog focus trap & `aria-describedby` for rejection reason
- Color contrast check for status badges (sick/holiday variants)
- Add keyboard shortcuts (e.g., / to focus employee search)
- Toasts: add role="status" or role="alert" semantics as library allows

---

## 12. Documentation Updates

- `MANAGER_DASHBOARD_PLAN.md` (this file)
- Update `ROLE_BASED_AUTH.md` with new announcement policies & clarified manager capabilities.
- Update `USAGE_GUIDE.md` with manager workflow examples (Approve leave, Post announcement).
- Add section to `README.md` listing manager dashboard features and screenshot (optional).

---

## 13. Deployment & Migration

1. Add migration file; commit.
2. Deploy (Vercel / hosting) – ensure `NEXT_PUBLIC_SUPABASE_URL` & service keys set.
3. Run migrations via Supabase CLI or dashboard SQL.
4. Smoke test: login as manager user; verify features.

Rollback Plan:

- If announcement migration fails, drop `team_announcements` table.
- Keep feature flag in component: if table not found, degrade gracefully (show info message).

---

## 14. Timeline (Indicative)

| Day | Tasks                                                                             |
| --- | --------------------------------------------------------------------------------- |
| 1   | Migration + types + announcements CRUD base                                       |
| 2   | Enhancements: Leave (filters, rejection dialog), Attendance (date range, summary) |
| 3   | Employees search, Performance sparkline, shared utilities, error boundary         |
| 4   | Testing (unit/integration), E2E scaffolding, accessibility fixes                  |
| 5   | Docs updates, polish, performance review, final QA                                |

---

## 15. Acceptance Criteria Checklist

- [ ] Announcements persist & list (create, list, pin, delete) with RLS protection.
- [ ] Weekly performance shows correct average & evaluation count; no console errors.
- [ ] Employee list searchable; profile dialog read-only; no restricted data leak.
- [ ] Attendance filter by name & date range; summary stats visible; export works.
- [ ] Leave requests: approve/reject with optional rejection reason; UI optimistic; reflects DB state after refresh.
- [ ] All queries scoped to manager department; attempts to access outside department fail under RLS.
- [ ] A11y: no critical axe errors on dashboard; dialog is keyboard navigable.
- [ ] Tests pass in CI (unit + integration + basic e2e scenario).
- [ ] Documentation updated & accurate.

---

## 16. Future / Stretch Ideas

- Real-time subscriptions (Supabase Realtime) for leave request status refresh.
- Notification system (toast or in-app badge) for new announcements.
- KPI dashboards (headcount, attrition, average tenure).
- Performance review workflow (draft -> submit -> signoff).
- Scheduling & shift management.

---

## 17. Risks & Mitigations

| Risk                               | Mitigation                                                                                        |
| ---------------------------------- | ------------------------------------------------------------------------------------------------- |
| RLS misconfiguration exposing data | Add integration tests asserting unauthorized access fails.                                        |
| Large data sets slow tables        | Introduce pagination & limit columns early.                                                       |
| Time zone inconsistencies          | Standardize to UTC in DB; format in client locale.                                                |
| Race conditions on leave approval  | Use row-level filter + status change check or add condition to update only when status='pending'. |
| Announcement spam                  | Limit length; optional throttle logic (client + later server).                                    |

---

## 18. Data Privacy Notes

- Emergency contact & personal info only visible to manager and HR; confirm with policy (if needed restrict via separate view/table or column-level RLS).
- Consider masking email/phone for non-manager peers (already not shown to other employees per existing policies). If not implemented, document assumption.

---

## 19. Summary

This plan closes the remaining functional gap (persistent announcements) and layers improvements in performance, UX, security, and testing. Following the outlined migration-first approach, we ensure data model stability early, then iterate through UI enhancements, culminating in robust testing and documentation for a production-ready Manager Dashboard.
